<!DOCTYPE html>
<!-- 
    Junat taulukossa palvelu
    
    Koska VR:n oma Lähtevät ja saapuvat junat (http://ext-service.vr.fi/juku/asema.action?junalaji=ll&asema=HKI) 
    on nihkee, niin piti tehdä parempi. Perustuen VRn Junat kartalla rajapintaan 
    (http://www.apps4finland.fi/fi/data/junat-kartalla-palvelun-rajapinta/), tämä sivu hakee
    aseman tiedot ja näyttää ne taulukossa.
    
    Axel Eirola. 2012
-->
<html>
<head>
    <meta charset='utf-8' />
    <title>Junat taulukossa</title>
    
    <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'></script>

<script type='text/javascript'>
var STATION_XML_URL = 'http://188.117.35.14/TrainRSS/TrainService.svc/stationInfo?station=';
var STATION_XML_PROXY_URL = 'proxy.php?station=';

var TRAIN_XML_URL = 'http://188.117.35.14/TrainRSS/TrainService.svc/trainInfo?train=';
var TRAIN_XML_PROXY_URL = 'proxy.php?train=';

// History time to show trains in
var HISTORY_MINUTES = 5;

$(document).ready(setValues);
$(document).ready(update);

/**
 * Set input field values from url parameters
 */
function setValues() { 'use strict';
    // Input
    var input = getUrlParam('asema') || 
                getUrlParam('junanro') || 
                getUrlParam('juna') || 
                getUrlParam('input') || 
                'HKI';
    $('#input').val(input);
    
    // Train type
    var train_type = getUrlParam('junalaji') || 
                     getUrlParam('laji') || 
                     getUrlParam('cat') || 
                     getUrlParam('category') || 
                     '0';
    switch(train_type) {
        case '1':
            $('#remote_trains').prop('checked', true);
            break;
        case '2':
            $('#local_trains').prop('checked', true);
            break;
        case '0':
            $('#all_trains').prop('checked', true);
            break;
        default:
            $('#all_trains').prop('checked', true);
            break;
    }
}

/**
 * Update page using parameter from input field.
 */
function update () { 'use strict';
    var input = $('#input').val().toUpperCase();
    
    if (/\d/.test(input)) {
        // Trains contain numbers
        updateTrain(input);
    } else {
        // Stations don't
        updateStation(input);
    }
}

/**
 * Update page with station information.
 */
function updateStation(station) { 'use strict';
    if (location.protocol === 'file:') {
        $.ajax({
            type: 'GET',
            url: STATION_XML_URL + station,
            dataType: 'xml',
            cache: false,
            success: drawStation
        });
    } else {
        $.ajax({
            type: 'GET',
            url: STATION_XML_PROXY_URL + station,
            dataType: 'xml',
            cache: false,
            success: drawStation
        });
    }
}

/**
 * Insert station information into page
 */
function drawStation(xml_doc) { 'use strict';
    // Get xml
    var xml = $(xml_doc);
    var channel = xml.find('channel');
    
    // Header data
    $('#title').html(channel.children('title').text());
    $('#lastbuilddate').html(channel.children('lastbuilddate').text());
    
    // Unused header data
    //$('#description').html(channel.children('description'));
    //$('#category').html(channel.children('category'));
    //$('#point').html(channel.children('point'));
    drawStationInfo();
    
    // Traintypes to show
    var traintypes = $('input:radio[name=train]:checked').val();
    
    // Get and init table
    var table = $('#table');
    table.empty();
    drawTrainHeaders();
    
    // Loop over items
    var items = channel.children('item');
    var pastNow = false;
    items.each(function(i) {
        var item = $(this);
        var category = item.children('category').text();
        var estimatedTime = item.children('etd').text();
        
        if ((traintypes === '0' || category === traintypes) && 
            (pastNow || diffToNow(estimatedTime) < HISTORY_MINUTES)) {
            
            var scheduledTime = item.children('scheduleddeparttime').text();
            var type = item.children('cat').text();
            var row = $('<tr>');
            
            // Check if we are past now
            if (!pastNow && diffToNow(scheduledTime) <= 0) {
                pastNow = true;
                row.addClass('now');
            }
            
            // Train number
            var trainNr = item.children('guid').text();
            row.append($('<td>').append(getLink(trainNr).html(item.children('title').text())));
            
            // Station (from / to)
            var station = item.children('tostation').text();
            //row.append($('<td>').html(item.children('fromstation')));
            row.append($('<td>').append(getLink(station)));
            
            //row.append($('<td>').html(item.children('scheduledtime')));
            row.append($('<td>').html(scheduledTime));
            
            //row.append($('<td>').html(item.children('eta')));
            row.append($('<td>').html(estimatedTime));
            
            var status = item.children('status').text();
            var lateness = item.children('lateness').text();
            row.append($('<td>').html(statusToString(status) + " (" + lateness + "s)"));
            row.append($('<td>').html(item.children('reasoncode').text()));
            
            // Unused data
            //row.append($('<td>').html($(this).children('pubdate').text()));
            //row.append($('<td>').html(type).text());
            //row.append($('<td>').html(category).text());
            //row.append($('<td>').html(item.children('description').text()));
            //row.append($('<td>').html(item.children('completed').text()));
            
            table.append(row);
        }
    });
}

/**
 * Show station specific information in informatin paragraph.
 */
function drawStationInfo() { 'use strict';
    $('#station_info').show();
    $('#train_info').hide();
}

/**
 * Insert train table headers into #table.
 */
function drawTrainHeaders() { 'use strict';
    var table = $('#table');
    var row = $('<tr>');
    //row.append($('<th>').html('pubdate'));
    //row.append($('<th>').html('guid'));
    row.append($('<th>').html('Juna'));
    //row.append($('<th>').html('Luokka'));
    //row.append($('<th>').html('category'));
    //row.append($('<th>').html('fromstation'));
    row.append($('<th>').html('Määränpää'));
    //row.append($('<th>').html('description'));
    //row.append($('<th>').html('scheduledtime'));
    row.append($('<th>').html('Lähtöaika'));
    //row.append($('<th>').html('eta'));
    row.append($('<th>').html('Arivoitu aika'));
    row.append($('<th>').html('Tila'));
    //row.append($('<th>').html('Myöhässä'));
    row.append($('<th>').html('Syy'));
    //row.append($('<th>').html('completed'));
    table.append(row);
}

/**
 * Update the page with train information
 */
function updateTrain(train) { 'use strict';
    if (location.protocol === 'file:') {
        $.ajax({
            type: 'GET',
            url: TRAIN_XML_URL + train,
            dataType: 'xml',
            cache: false,
            success: drawTrain
        });
    } else {
        $.ajax({
            type: 'GET',
            url: TRAIN_XML_PROXY_URL + train,
            dataType: 'xml',
            cache: false,
            success: drawTrain
        });
    }
}

/**
 * Insert train data into page.
 */
function drawTrain(xml_doc) { 'use strict';
    var xml = $(xml_doc);
    var channel = xml.find('channel');
    
    $('#title').html(channel.children('title').text());
    $('#lastbuilddate').html(channel.children('lastbuilddate').text());
    drawTrainInfo(channel);
    
    var table = $('#table');
    table.empty();
    drawStationHeaders();
    
    var items = channel.children('item');
    var past_now = false;
    items.each(function(i) {
        var item = $(this);
        var completed = $(this).children('completed').text();
        var row = $('<tr>');
        
        // Check if we are past now
        if (!past_now && completed === '0') {
            past_now = true;
            row.addClass('now');
        }
        
        var station = item.children('stationcode').text();
        row.append($('<td>').append(getLink(station)));
        
        row.append($('<td>').html($(this).children('scheduledtime').text()));
        row.append($('<td>').html($(this).children('scheduleddeparttime').text()));
        row.append($('<td>').html($(this).children('eta').text()));
        row.append($('<td>').html($(this).children('etd').text()));

        var status = $(this).children('status').text();
        row.append($('<td>').html(statusToString(status)));
        table.append(row);
    });
}

/**
 * Show train specific information in information paragraph.
 */
function drawTrainInfo(channel) { 'use strict';
    $('#speed').html(channel.children('speed').text());
    $('#status').html(statusToString(channel.children('status').text()));
    $('#reasoncode').html(channel.children('reasoncode').text());
    $('#lateness').html(channel.children('lateness').text());
    
    $('#station_info').hide();
    $('#train_info').show();
}

/**
 * Insert station table headers to #table.
 */
function drawStationHeaders() { 'use strict';
    var table = $('#table');
    var row = $('<tr>');
    row.append($('<th>').html('Asema'));
    row.append($('<th>').html('Saapumisaika'));
    row.append($('<th>').html('Lähtöaika'));
    row.append($('<th>').html('Arivoitu saapumisaika'));
    row.append($('<th>').html('Arivoitu lähtöaika'));
    row.append($('<th>').html('Tila'));
    table.append(row);
}

/**
 * Generate link to given train/station.
 */
function getLink(input) { 'use strict';
    return $('<a>').attr('href', '#').click(
        function() {
            $('#input').val(input);
            update();
        }).html(input);
}

/**
 * Get string representation of status.
 */
function statusToString(status) { 'use strict';
    switch(status) {
        case '1':
            return 'Ajoissa';
        case '2':
            return 'Myöhässä';
        case '3':
            return 'Paljon myöhässä';
        case '5':
            return 'Peruuttu';
        default:
            return 'Tuntematon';
    }
}

/**
 * Get the duration from timeString to now() in minutes. Negative if timeString past now().
 * Day changes at now()+12h and now()-12h.
 */
function diffToNow(timeString) { 'use strict';
    var fields = timeString.split(':');
    var trainMinutes = 60*parseInt(fields[0], 10) + parseInt(fields[1], 10);
    
    var now = new Date();
    var nowMinutes = 60*now.getHours() + now.getMinutes();
    
    var diff = nowMinutes - trainMinutes;
    if (12*60 < Math.abs(diff)) {
        return diff-24;
    } else {
        return diff;
    }
}

/**
 * Get the the value of the given url parameter
 */
function getUrlParam(name) { 'use strict';
    var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(window.location.href);
    if (results) {
        return results[1];
    } else {
        return null;
    }
}
</script>

<style type='text/css'>
    body {
        font-family:sans-serif;
    }
    
    h1, h1 #title, h1 #input {
        color:#C00;
        font-weight: bold;
        font-size: 1cm;
        margin:0;
    }
    
    h1 #input {
        border: 1px dashed #666;
        background: #ffc;
    }
    
    p#lastbuilddate {
        color:gray;
        margin:0;
        font-style:italic;
    }
    
    table#table {
        border:none;
    }
    
    table#table th {
        color:white;
        background:#C00;
        padding: 0.1em 1em 0.1em 1em;
    }
    
    table#table a {
        color:#C00;
        text-decoration:none;
    }
    
    table#table td {
        padding: 0.1em 0.2em 0.1em 0.2em;
    }
    
    table#table tr:nth-child(even) {
        background: #FFF;
    }
    
    table#table tr:nth-child(odd) {
        background: #DDD;
    }
    
    table#table tr.now td {
        border-top: 3px solid #C00;
    }
    
</style>
</head>

<body>
    <h1>
        <input id='input' type='text' size='8' onchange='update()'/>
        (<span id='title'></span>)
    </h1>
    <p id='lastbuilddate'></p>
    <p id='station_info' style='display: none'>
        <input type='radio' name='train' id='remote_trains' value='1' onchange='update()'/>
        <label for='remote_trains'>Kaukojunat</label>
        <input type='radio' name='train' id='local_trains' value='2'  onchange='update()'/>
        <label for='local_trains'>Lähijunat</label>
        <input type='radio' name='train' id='all_trains' value='0'  onchange='update()' checked='checked'/>
        <label for='all_trains'>Kaikki</label>
    </p>
    <p id='train_info' style='display: none'>
        Nopeus: <span id='speed'>??</span>km/h,
        Tila: <span id='status'>??</span> (<span id='lateness'>??</span>s),
        Syykoodi: <span id='reasoncode'>??</span>
    </p>
    <table id='table'></table>
</body>
</html>
